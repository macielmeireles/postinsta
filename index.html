
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Post Designer v9.2 - Single File</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* Font import */
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Playfair+Display:ital,wght@1,600&display=swap');

    body { background: #0b0f19; color: #e5e7eb; font-family: Montserrat, sans-serif; }
    .font-serif { font-family: 'Playfair Display', serif; }
    .font-sans { font-family: 'Montserrat', sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 6px; }
    input[type=range] { -webkit-appearance: none; background: transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fbbf24; cursor: pointer; margin-top: -5px; box-shadow: 0 0 4px rgba(0,0,0,0.5); }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 2px; cursor: pointer; background: #374151; }
    .custom-scrollbar { scrollbar-width: thin; scrollbar-color: #374151 transparent; }
  </style>
</head>
<body>
  <div id="root" class="h-screen"></div>

  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <!-- Utilities -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- Application -->
  <script type="text/babel">
  // Post Designer v9.2 - Single-file runnable version
  // Mantive coment√°rios e estrutura principal do patch que disponibilizei.
  const { useState, useEffect, useRef, useMemo } = React;

  // =================================================================================
  // Configura√ß√µes e constantes
  // =================================================================================
  const APP_VERSION = "9.2";
  const STORAGE_KEY = "post_designer_v9_data_singlefile";

  const FORMATS = {
    story: {
      label: 'Story (9:16)',
      dims: { width: 1080, height: 1920 },
      logoBaseWidth: 650,
      titleGap: 'gap-y-6',
      padding: 'pt-32 pb-28 px-10',
      baseSizes: {
        preTitle: 40,
        mainTitle: 150,
        subtitle: 54,
        infoLabel: 24,
        infoValue: 72,
        footerTitle: 32,
        footerAddr: 38
      }
    },
    post: {
      label: 'Post (4:5)',
      dims: { width: 1080, height: 1350 },
      logoBaseWidth: 480,
      titleGap: 'gap-y-5',
      padding: 'pt-28 pb-20 px-12',
      baseSizes: {
        preTitle: 28,
        mainTitle: 120,
        subtitle: 40,
        infoLabel: 18,
        infoValue: 48,
        footerTitle: 24,
        footerAddr: 30
      }
    }
  };

  const INITIAL_THEME = { accent: '#fbbf24', bg: '#0e162b', text: '#ffffff' };
  const INITIAL_TEXTS = {
    preTitle: 'ESTUDO DA PALAVRA',
    mainTitle: 'ESCOLA\\nB√çBLICA',
    subtitle: '"Venha crescer na gra√ßa e no conhecimento."',
    day: 'Toda Ter√ßa',
    time: '19h',
    footerTitle: 'IGREJA EVANG√âLICA ARCA',
    address1: 'Est. dos Bandeirantes, 11.609 / Qd-04 Lt-54',
    address2: 'Vargem Pequena'
  };

  const INITIAL_VERSES_LIST = [
    "Tua Palavra √© l√¢mpada que ilumina os meus passos e luz que clareia o meu caminho! (Sl 119:105)",
    "Toda Escritura √© dada pela inspira√ß√£o de Deus... (2Tm 3:16)",
    "Estes foram mais nobres do que os de Tessal√¥nica... (At 17:11)",
    "Porque o SENHOR d√° a sabedoria... (Pv 2:6)",
    "Este livro da lei n√£o se apartar√° de tua boca... (Js 1:8)",
    "Quanto amo a tua Lei! Sobre ela reflito o dia inteira! (Sl 119:97)",
    "A exposi√ß√£o das tuas palavras ilumina e d√° entendimento aos inexperientes! (Sl 119:130)"
  ];

  const FALLBACK_VERSES = [
    "O Senhor √© o meu pastor; de nada terei falta. (Salmos 23:1)",
    "Tudo posso naquele que me fortalece. (Filipenses 4:13)",
    "Mas os que esperam no Senhor renovar√£o as for√ßas. (Isa√≠as 40:31)",
    "Busquem, pois, em primeiro lugar o Reino de Deus. (Mateus 6:33)",
    "Confie no Senhor de todo o cora√ß√£o. (Prov√©rbios 3:5)"
  ];

  const INITIAL_SCALES = {
    logo: 100, logoX: 0, logoY: 0,
    preTitle: 100, preTitleX: 0, preTitleY: 0, preTitleSize: 100,
    mainTitle: 100, mainTitleX: 0, mainTitleY: 0, mainTitleSize: 100,
    subtitle: 100, subtitleX: 0, subtitleY: 0, subtitleWidth: 90, subtitleSize: 100,
    info: 100, infoTextSize: 100,
    footerTitle: 100, footerTitleX: 0, footerTitleY: 0, footerTitleSize: 100,
    footerAddr1: 100, footerAddr1X: 0, footerAddr1Y: 0, footerAddr1Size: 100,
    footerAddr2: 100, footerAddr2X: 0, footerAddr2Y: 0, footerAddr2Size: 100,
    footerWidth: 100,
    shadowBlur: 20,
    pillPadding: 36,
    pillTitleTop: 28,
    pillIconY: 0,
    pillX: 0, pillY: -17, pillTextX: 0, pillTextY: -17
  };

  const INITIAL_BG = { opacity: 50, scale: 100, x: 0, y: 0 };

  // =================================================================================
  // Componentes utilit√°rios (substituem √≠cones por elementos simples para evitar depend√™ncias)
  // =================================================================================
  const Icon = ({ label }) => <span style={{ display: 'inline-block', width: 16, textAlign: 'center' }}>{label}</span>;
  const Scaling = () => <Icon label="‚á≤" />;
  const Type = () => <Icon label="A" />;
  const Edit3 = () => <Icon label="‚úé" />;
  const Loader = () => <span className="animate-spin">‚ü≥</span>;
  const DownloadIcon = () => <Icon label="‚á©" />;
  const CodeIcon = () => <Icon label="{}" />;

  // =================================================================================
  // DraggableItem - atualizado para pointer events (mesma l√≥gica do patch fornecido)
  // =================================================================================
  function DraggableItem({ children, x = 0, y = 0, scaleVal = 100, fontSizeVal = 100, onMove, onScale, onFontSize, onEdit, id, className = "", disabled = false, fitContent = true }) {
    const [isHovered, setIsHovered] = useState(false);
    const isDragging = useRef(false);
    const isResizingScale = useRef(false);
    const isResizingFont = useRef(false);
    const startPos = useRef({ x: 0, y: 0 });
    const startValues = useRef({ x: 0, y: 0, scale: 100, font: 100 });

    useEffect(() => {
      return () => {
        document.removeEventListener('pointermove', handlePointerMove);
        document.removeEventListener('pointerup', handlePointerUp);
      };
    }, []);

    const attachListeners = () => {
      document.addEventListener('pointermove', handlePointerMove);
      document.addEventListener('pointerup', handlePointerUp);
    };

    const handlePointerMove = (e) => {
      e.preventDefault && e.preventDefault();
      if (isDragging.current) {
        const deltaX = (e.clientX - startPos.current.x);
        const deltaY = (e.clientY - startPos.current.y);
        const newX = Math.round(startValues.current.x + deltaX);
        const newY = Math.round(startValues.current.y + deltaY);
        if (onMove) onMove(newX, newY);
      } else if (isResizingScale.current) {
        const deltaX = (e.clientX - startPos.current.x);
        let newScale = Math.round(Math.max(20, Math.min(400, startValues.current.scale + (deltaX * 0.5))));
        if (onScale) onScale(newScale);
      } else if (isResizingFont.current) {
        const deltaX = (e.clientX - startPos.current.x);
        let newFont = Math.round(Math.max(20, Math.min(300, startValues.current.font + (deltaX * 0.5))));
        if (onFontSize) onFontSize(newFont);
      }
    };

    const handlePointerUp = () => {
      isDragging.current = false;
      isResizingScale.current = false;
      isResizingFont.current = false;
      document.removeEventListener('pointermove', handlePointerMove);
      document.removeEventListener('pointerup', handlePointerUp);
    };

    const handlePointerDownDrag = (e) => {
      if (disabled || isResizingScale.current || isResizingFont.current) return;
      if (e.button && e.button !== 0) return;
      e.stopPropagation(); e.preventDefault();
      isDragging.current = true;
      startPos.current = { x: e.clientX, y: e.clientY };
      startValues.current = { x, y };
      attachListeners();
    };

    const handlePointerDownScale = (e) => {
      if (disabled) return;
      e.stopPropagation(); e.preventDefault();
      isResizingScale.current = true;
      startPos.current = { x: e.clientX, y: e.clientY };
      startValues.current = { scale: scaleVal || 100 };
      attachListeners();
    };

    const handlePointerDownFont = (e) => {
      if (disabled) return;
      e.stopPropagation(); e.preventDefault();
      isResizingFont.current = true;
      startPos.current = { x: e.clientX, y: e.clientY };
      startValues.current = { font: fontSizeVal || 100 };
      attachListeners();
    };

    return (
      <div
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
        onPointerDown={handlePointerDownDrag}
        onDoubleClick={() => onEdit && onEdit(id)}
        className={`${className} ${disabled ? '' : 'group relative z-10'}`}
        style={{
          transform: `translate(${x}px, ${y}px)`,
          touchAction: 'none',
          width: fitContent ? 'max-content' : 'auto',
          maxWidth: '100%',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center'
        }}
        title={onEdit ? "Arrastar (Clique), Editar (Duplo Clique)" : ""}
      >
        <div className={`transition-all duration-200 relative ${isHovered && !disabled ? 'ring-1 ring-white/50 bg-white/5 rounded-lg cursor-move' : ''}`}>
          {children}
          {isHovered && !disabled && (
            <>
              {onScale && (
                <div
                  onPointerDown={handlePointerDownScale}
                  className="absolute -bottom-2 -right-2 w-5 h-5 bg-white text-black rounded-full shadow-lg flex items-center justify-center cursor-nwse-resize hover:scale-125 transition-transform z-50 border border-gray-400"
                  title="Zoom da Caixa"
                >
                  <Scaling />
                </div>
              )}
              {onFontSize && (
                <div
                  onPointerDown={handlePointerDownFont}
                  className="absolute -top-2 -right-2 w-5 h-5 bg-[#fbbf24] text-black rounded-full shadow-lg flex items-center justify-center cursor-ew-resize hover:scale-125 transition-transform z-50 border border-yellow-600"
                  title="Tamanho da Fonte"
                >
                  <Type />
                </div>
              )}
              {onEdit && (
                <div className="absolute -top-2 -left-2 w-5 h-5 bg-blue-500 text-white rounded-full shadow-lg flex items-center justify-center z-40 opacity-70 pointer-events-none">
                  <Edit3 />
                </div>
              )}
            </>
          )}
        </div>
      </div>
    );
  }

  // =================================================================================
  // Componentes menores
  // =================================================================================
  function RangeControl({ label, value, onChange, min = 50, max = 200, unit = '%', displayValue = true, color }) {
    return (
      <div className="space-y-1">
        <div className="flex justify-between text-[11px] font-bold text-gray-400 uppercase">
          <span>{label}</span>
          {displayValue && <span style={{ color }}>{value}{unit}</span>}
        </div>
        <input type="range" min={min} max={max} value={value} onChange={e => onChange(Number(e.target.value))} className="w-full" />
      </div>
    );
  }

  function InputGroup({ label, value, onChange, isArea, rows = 1 }) {
    const className = "w-full bg-[#1f2937] border border-gray-700 rounded-lg px-3 py-2 text-xs font-medium text-white focus:border-gray-500 focus:ring-1 focus:ring-gray-500 focus:outline-none transition resize-none placeholder-gray-600";
    return (
      <div>
        <label className="text-[10px] font-bold text-gray-500 uppercase ml-1 mb-1 block">{label}</label>
        {isArea ? <textarea rows={rows} value={value} onChange={e => onChange(e.target.value)} className={className} /> : <input type="text" value={value} onChange={e => onChange(e.target.value)} className={className} />}
      </div>
    );
  }

  // =================================================================================
  // CanvasArtwork (renderiza a arte e usa DraggableItem)
  // =================================================================================
  const CanvasArtwork = React.forwardRef(({ format, theme, texts, scales, images, bgConfig, onElementMove, onElementResize, onElementFontSize, isExporting, onEditElement }, ref) => {
    const fmt = FORMATS[format];
    const getFontSize = (base, scale) => \`\${base * (scale / 100)}px\`;
    const logoStyle = { width: fmt.logoBaseWidth * (scales.logo / 100) };

    return (
      <div ref={ref} className="w-full h-full relative overflow-hidden flex flex-col items-center text-center select-none" style={{ backgroundColor: theme.bg, color: theme.text }}>
        <div className="absolute inset-0 z-0" style={{ backgroundColor: theme.bg }}></div>

        {images.bg && (
          <div className="absolute top-1/2 left-1/2 w-full h-full pointer-events-none z-0" style={{ transform: \`translate(calc(-50% + \${bgConfig.x}%), calc(-50% + \${bgConfig.y}%)) scale(\${bgConfig.scale / 100})\`, opacity: bgConfig.opacity / 100 }}>
            <div style={{ width: '100%', height: '100%', backgroundImage: \`url(\${images.bg})\`, backgroundSize: 'cover', backgroundPosition: 'center', backgroundRepeat: 'no-repeat' }} />
          </div>
        )}

        <div className={\`relative z-20 w-full h-full flex flex-col justify-between \${fmt.padding}\`}>
          <div className="flex-grow-[1] flex items-center justify-center relative">
            <DraggableItem id="logo" x={scales.logoX} y={scales.logoY} scaleVal={scales.logo} fontSizeVal={scales.logo} onMove={(x,y) => onElementMove('logo', x, y)} onScale={(s) => onElementResize('logo', s)} disabled={isExporting}>
              <div style={logoStyle} className="relative flex justify-center items-center drop-shadow-2xl">
                {images.logo ? <img src={images.logo} className="w-full h-auto object-contain drop-shadow-xl" alt="Logo" /> : <div className="font-serif italic leading-none tracking-tighter text-[64px]"><span style={{ color: theme.accent }}>LOGO</span></div>}
              </div>
            </DraggableItem>
          </div>

          <div className={\`flex-grow-[2] flex flex-col items-center justify-center w-full \${fmt.titleGap}\`}>
            <DraggableItem id="preTitle" x={scales.preTitleX} y={scales.preTitleY} scaleVal={scales.preTitle} fontSizeVal={scales.preTitleSize} onMove={(x,y) => onElementMove('preTitle', x, y)} onScale={(s) => onElementResize('preTitle', s)} onFontSize={(s) => onElementFontSize('preTitle', s)} onEdit={onEditElement} disabled={isExporting}>
              <div className="flex items-center gap-4 w-full justify-center">
                <div className="h-[1px] w-8 opacity-60" style={{ background: theme.accent }}></div>
                <h3 className="font-bold tracking-[0.25em] uppercase font-sans whitespace-nowrap" style={{ color: theme.accent, fontSize: getFontSize(fmt.baseSizes.preTitle, scales.preTitleSize || 100) }}>{texts.preTitle}</h3>
                <div className="h-[1px] w-8 opacity-60" style={{ background: theme.accent }}></div>
              </div>
            </DraggableItem>

            <DraggableItem id="mainTitle" x={scales.mainTitleX} y={scales.mainTitleY} scaleVal={scales.mainTitle} fontSizeVal={scales.mainTitleSize} onMove={(x,y) => onElementMove('mainTitle', x, y)} onScale={(s) => onElementResize('mainTitle', s)} onFontSize={(s) => onElementFontSize('mainTitle', s)} onEdit={onEditElement} disabled={isExporting}>
              <h1 className="font-black leading-[0.85] tracking-tight font-sans uppercase text-white" style={{ fontSize: getFontSize(fmt.baseSizes.mainTitle, scales.mainTitleSize || 100), whiteSpace: 'pre-line' }}>{texts.mainTitle}</h1>
            </DraggableItem>

            {texts.subtitle && (
              <DraggableItem id="subtitle" x={scales.subtitleX} y={scales.subtitleY} scaleVal={scales.subtitle} fontSizeVal={scales.subtitleSize} onMove={(x,y) => onElementMove('subtitle', x, y)} onScale={(s) => onElementResize('subtitle', s)} onFontSize={(s) => onElementFontSize('subtitle', s)} onEdit={onEditElement} disabled={isExporting} className="w-full flex justify-center">
                <div style={{ width: \`\${scales.subtitleWidth}%\`, margin: '0 auto' }}>
                  <p className="text-gray-100 italic font-serif leading-snug opacity-90 drop-shadow-md text-center break-words" style={{ fontSize: getFontSize(fmt.baseSizes.subtitle, scales.subtitleSize || 100), whiteSpace: 'pre-wrap' }}>
                    {texts.subtitle}
                  </p>
                </div>
              </DraggableItem>
            )}
          </div>

          <div className="flex-grow-[1] flex flex-col items-center justify-end relative">
            <DraggableItem id="pill" x={scales.pillX} y={scales.pillY} scaleVal={scales.info} fontSizeVal={scales.infoTextSize} onMove={(x,y) => onElementMove('pill', x, y)} onScale={(s) => onElementResize('pill', s)} className="mb-0 relative z-30" disabled={isExporting}>
              <div className="rounded-full border border-white/30 shadow-2xl backdrop-blur-lg overflow-hidden flex items-center relative" style={{ backgroundColor: 'rgba(255, 255, 255, 0.15)', transform: \`scale(\${scales.info / 100})\`, padding: \`\${scales.pillPadding}px 2rem\` }}>
                <div className="rounded-full w-14 h-14 flex items-center justify-center shadow-lg mr-6 absolute left-4" style={{ backgroundColor: theme.accent, color: theme.bg, transform: \`translateY(\${scales.pillIconY}px)\` }}>‚è∞</div>
                <div className="flex divide-x divide-white/20 pl-16" style={{ transform: \`translate(\${scales.pillTextX}px, \${scales.pillTextY}px)\` }}>
                  <div className="px-6 pill-text-container text-left min-w-[160px]"><p className="text-white/80 uppercase font-bold tracking-widest mb-1 text-[10px]" style={{ fontSize: getFontSize(fmt.baseSizes.infoLabel, scales.infoTextSize) }}>QUANDO</p><p className="font-bold text-white tracking-tight leading-none whitespace-nowrap" style={{ fontSize: getFontSize(fmt.baseSizes.infoValue, scales.infoTextSize) }}>{texts.day}</p></div>
                  <div className="px-6 pill-text-container text-left min-w-[120px]"><p className="text-white/80 uppercase font-bold tracking-widest mb-1 text-[10px]" style={{ fontSize: getFontSize(fmt.baseSizes.infoLabel, scales.infoTextSize) }}>HOR√ÅRIO</p><p className="font-bold text-white tracking-tight leading-none whitespace-nowrap" style={{ fontSize: getFontSize(fmt.baseSizes.infoValue, scales.infoTextSize) }}>{texts.time}</p></div>
                </div>
              </div>
            </DraggableItem>

            <div className="flex-grow"></div>
            <div className="w-full flex flex-col items-center justify-center pointer-events-none">
              <div className="pointer-events-auto mb-1">
                <DraggableItem id="footerTitle" x={scales.footerTitleX} y={scales.footerTitleY} scaleVal={scales.footerTitle} fontSizeVal={scales.footerTitleSize} onMove={(x,y) => onElementMove('footerTitle', x, y)} onScale={(s) => onElementResize('footerTitle', s)} onFontSize={(s) => onElementFontSize('footerTitle', s)} onEdit={onEditElement} disabled={isExporting}>
                  <p className="uppercase font-bold tracking-[0.2em] text-center" style={{ color: theme.accent, fontSize: getFontSize(fmt.baseSizes.footerTitle, scales.footerTitleSize || 100) }}>{texts.footerTitle}</p>
                </DraggableItem>
              </div>

              <div className="flex flex-col items-center justify-center text-gray-300 pointer-events-auto">
                <div className="mb-0.5" style={{ width: \`\${scales.footerWidth || 100}%\` }}>
                  <DraggableItem id="footerAddr1" x={scales.footerAddr1X} y={scales.footerAddr1Y} scaleVal={scales.footerAddr1} fontSizeVal={scales.footerAddr1Size} onMove={(x,y) => onElementMove('footerAddr1', x, y)} onScale={(s) => onElementResize('footerAddr1', s)} onFontSize={(s) => onElementFontSize('footerAddr1', s)} onEdit={onEditElement} disabled={isExporting} className="w-full flex justify-center">
                    <div className="flex items-center justify-center gap-1.5 w-full text-center">
                      <span style={{ marginRight: 6 }}>üìç</span>
                      <p className="font-medium tracking-wide whitespace-nowrap" style={{ fontSize: getFontSize(fmt.baseSizes.footerAddr, scales.footerAddr1Size || 100) }}>{texts.address1}</p>
                    </div>
                  </DraggableItem>
                </div>

                <div style={{ width: \`\${scales.footerWidth || 100}%\` }}>
                  <DraggableItem id="footerAddr2" x={scales.footerAddr2X} y={scales.footerAddr2Y} scaleVal={scales.footerAddr2} fontSizeVal={scales.footerAddr2Size} onMove={(x,y) => onElementMove('footerAddr2', x, y)} onScale={(s) => onElementResize('footerAddr2', s)} onFontSize={(s) => onElementFontSize('footerAddr2', s)} onEdit={onEditElement} disabled={isExporting} className="w-full flex justify-center">
                    <p className="font-medium opacity-80 text-center w-full" style={{ fontSize: getFontSize(fmt.baseSizes.footerAddr, scales.footerAddr2Size || 100) }}>{texts.address2}</p>
                  </DraggableItem>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    );
  });

  // =================================================================================
  // Main App
  // =================================================================================
  function App() {
    const [format, setFormat] = useState('story');
    const [theme, setTheme] = useState({ ...INITIAL_THEME });
    const [texts, setTexts] = useState({ ...INITIAL_TEXTS });
    const [scales, setScales] = useState({ ...INITIAL_SCALES });
    const [images, setImages] = useState({ logo: null, bg: null });
    const [bgConfig, setBgConfig] = useState({ ...INITIAL_BG });
    const [savedVerses, setSavedVerses] = useState([...INITIAL_VERSES_LIST]);
    const [newVerseInput, setNewVerseInput] = useState("");
    const [isLoadingVerse, setIsLoadingVerse] = useState(false);
    const [activeTab, setActiveTab] = useState('texts');
    const [previewScale, setPreviewScale] = useState(1);
    const [isExporting, setIsExporting] = useState(false);
    const [isAutoSaved, setIsAutoSaved] = useState(false);
    const [editingId, setEditingId] = useState(null);
    const [tempText, setTempText] = useState("");

    const artworkRef = useRef(null);
    const containerRef = useRef(null);
    const fileInputLogo = useRef(null);
    const fileInputBg = useRef(null);

    // INIT from localStorage
    useEffect(() => {
      const savedData = localStorage.getItem(STORAGE_KEY);
      if (savedData) {
        try {
          const d = JSON.parse(savedData);
          if (d.texts) setTexts(d.texts);
          if (d.scales) setScales(d.scales);
          if (d.theme) setTheme(d.theme);
          if (d.format) setFormat(d.format);
          if (d.savedVerses) setSavedVerses(d.savedVerses);
          if (d.bgConfig) setBgConfig(d.bgConfig);
          if (d.images) setImages(d.images);
        } catch (e) { console.error("Erro load save", e); }
      }
    }, []);

    // Auto save
    useEffect(() => {
      const timeout = setTimeout(() => {
        const data = { format, theme, texts, scales, images, bgConfig, savedVerses, version: APP_VERSION };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        setIsAutoSaved(true);
        setTimeout(() => setIsAutoSaved(false), 1200);
      }, 1200);
      return () => clearTimeout(timeout);
    }, [format, theme, texts, scales, images, bgConfig, savedVerses]);

    // Resize handler for preview scale
    useEffect(() => {
      const handleResize = () => {
        if (!containerRef.current) return;
        const parent = containerRef.current;
        const dim = FORMATS[format].dims;
        let s = Math.min((parent.clientWidth - 40) / dim.width, (parent.clientHeight - 40) / dim.height);
        setPreviewScale(Math.max(0.1, Math.min(s, 0.95)));
      };
      window.addEventListener('resize', handleResize);
      setTimeout(handleResize, 100);
      return () => window.removeEventListener('resize', handleResize);
    }, [format]);

    const handleTextChange = (key, value) => setTexts(p => ({ ...p, [key]: value }));
    const handleScaleChange = (key, value) => setScales(p => ({ ...p, [key]: Number(value) }));

    const handleMoveElement = (element, newX, newY) => {
      if (scales.hasOwnProperty(`${element}X`)) setScales(p => ({ ...p, [`${element}X`]: newX, [`${element}Y`]: newY }));
      else if (element === 'pill') setScales(p => ({ ...p, pillX: newX, pillY: newY }));
    };

    const handleResizeElement = (element, newScale) => {
      if (element === 'pill') setScales(p => ({ ...p, info: newScale }));
      else setScales(p => ({ ...p, [element]: newScale }));
    };

    const handleFontSizeElement = (element, newSize) => {
      if (scales.hasOwnProperty(`${element}Size`)) setScales(p => ({ ...p, [`${element}Size`]: newSize }));
      else if (element === 'info') setScales(p => ({ ...p, infoTextSize: newSize }));
    };

    const resetAll = () => {
      if (!confirm("Resetar?")) return;
      setTexts({ ...INITIAL_TEXTS });
      setScales({ ...INITIAL_SCALES });
      setBgConfig({ ...INITIAL_BG });
      setTheme({ ...INITIAL_THEME });
    };

    const startEditing = (id) => {
      if (texts.hasOwnProperty(id)) {
        setTempText(texts[id]);
        setEditingId(id);
      } else if (id === 'footerTitle') {
        setTempText(texts.footerTitle);
        setEditingId('footerTitle');
      } else if (id === 'footerAddr1') {
        setTempText(texts.address1);
        setEditingId('address1');
      } else if (id === 'footerAddr2') {
        setTempText(texts.address2);
        setEditingId('address2');
      }
    };

    const saveEditing = () => {
      if (!editingId) return;
      handleTextChange(editingId, tempText);
      setEditingId(null);
    };

    // Image upload handlers
    const handleUpload = (e, type) => {
      const file = e.target.files && e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => setImages(prev => ({ ...prev, [type]: ev.target.result }));
        reader.readAsDataURL(file);
      }
    };

    const fetchRandomVerse = async () => {
      setIsLoadingVerse(true);
      try {
        const res = await fetch('https://www.abibliadigital.com.br/api/verses/nvi/random');
        if (!res.ok) throw new Error();
        const data = await res.json();
        setSavedVerses(p => [\`"\${data.text}" (\${data.book.name} \${data.chapter}:\${data.number})\`, ...p]);
      } catch (e) {
        setSavedVerses(p => [FALLBACK_VERSES[Math.floor(Math.random() * FALLBACK_VERSES.length)], ...p]);
      } finally { setIsLoadingVerse(false); }
    };

    const downloadArtwork = async () => {
      if (!artworkRef.current || !window.html2canvas) return;
      setIsExporting(true);
      await new Promise(r => setTimeout(r, 200));
      try {
        const timestamp = Date.now();
        const baseFilename = \`arte-igreja-\${format}-v\${APP_VERSION}-\${timestamp}\`;
        // JSON
        const jsonLink = document.createElement('a');
        jsonLink.href = URL.createObjectURL(new Blob([JSON.stringify({
          version: APP_VERSION, format, theme, texts, scales, bg: { ...bgConfig, src: images.bg }, logo: { src: images.logo }, savedVerses
        }, null, 2)], { type: 'application/json' }));
        jsonLink.download = \`\${baseFilename}.json\`;
        jsonLink.click();

        // Image via html2canvas
        const element = artworkRef.current;
        const clone = element.cloneNode(true);
        const wrapper = document.createElement('div');
        Object.assign(wrapper.style, { position: 'fixed', left: '-9999px', top: '0', width: \`\${FORMATS[format].dims.width}px\`, height: \`\${FORMATS[format].dims.height}px\`, zIndex: '-9999' });
        clone.style.transform = 'none';
        wrapper.appendChild(clone);
        document.body.appendChild(wrapper);

        const canvas = await window.html2canvas(clone, { scale: 3, useCORS: true, allowTaint: true, width: FORMATS[format].dims.width, height: FORMATS[format].dims.height, backgroundColor: theme.bg });
        const imgLink = document.createElement('a');
        imgLink.download = \`\${baseFilename}.jpg\`;
        imgLink.href = canvas.toDataURL('image/jpeg', 1.0);
        imgLink.click();
        document.body.removeChild(wrapper);
      } catch (err) { alert("Erro exporta√ß√£o."); } finally { setIsExporting(false); }
    };

    return (
      <div className="bg-[#0b0f19] text-gray-100 h-screen flex flex-col md:flex-row overflow-hidden">
        <div className="w-full md:w-[360px] bg-[#0b0f19] border-r border-gray-800 flex flex-col h-full">
          <div className="p-3 border-b border-gray-800 flex items-center justify-between bg-[#0e1422]">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 rounded bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center text-white shadow-lg"><span>IG</span></div>
              <div><h1 className="text-xs font-bold text-gray-200 tracking-wider">POST DESIGNER</h1><p className="text-[9px] text-gray-500 font-mono">v{APP_VERSION} - single file</p></div>
            </div>
            <div className="flex gap-1">
              <button onClick={() => {
                const zip = new JSZip();
                zip.file("project_snapshot.html", document.documentElement.outerHTML);
                zip.generateAsync({ type: "blob" }).then((content) => {
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(content);
                  link.download = "post-designer-snapshot.zip";
                  link.click();
                });
              }} className="p-2 hover:bg-gray-800 rounded text-gray-400">Salvar ZIP</button>
            </div>
          </div>

          <div className="p-3 grid grid-cols-2 gap-2">
            <button className="py-2 rounded bg-gray-800 text-sm font-bold">Story</button>
            <button className="py-2 rounded bg-gray-800 text-sm font-bold">Post</button>
          </div>

          <div className="p-4 overflow-y-auto flex-1 space-y-4 custom-scrollbar">
            {activeTab === 'texts' && (
              <div className="space-y-4">
                <InputGroup label="Chap√©u" value={texts.preTitle} onChange={(v) => setTexts(p => ({ ...p, preTitle: v }))} />
                <InputGroup label="T√≠tulo" value={texts.mainTitle} onChange={(v) => setTexts(p => ({ ...p, mainTitle: v }))} isArea rows={3} />
                <InputGroup label="Frase" value={texts.subtitle} onChange={(v) => setTexts(p => ({ ...p, subtitle: v }))} isArea rows={2} />
                <div className="pt-4 border-t border-gray-800">
                  <div className="grid grid-cols-2 gap-2">
                    <InputGroup label="Dia" value={texts.day} onChange={(v) => setTexts(p => ({ ...p, day: v }))} />
                    <InputGroup label="Hora" value={texts.time} onChange={(v) => setTexts(p => ({ ...p, time: v }))} />
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'verses' && (
              <div className="space-y-3">
                <button onClick={fetchRandomVerse} className="w-full py-2 rounded bg-blue-800">Vers√≠culo aleat√≥rio {isLoadingVerse && <Loader />}</button>
                <div className="max-h-[220px] overflow-y-auto space-y-2">
                  {savedVerses.map((v,i) => (
                    <div key={i} className="bg-gray-900 p-2 rounded">
                      <p className="text-xs italic line-clamp-3">"{v}"</p>
                      <div className="flex justify-end gap-2 mt-2">
                        <button onClick={() => setSavedVerses(p => p.filter((_, idx) => idx !== i))} className="text-red-400">Remover</button>
                        <button onClick={() => setTexts(p => ({ ...p, subtitle: v }))} className="bg-green-900/30 px-2 rounded text-xs">Usar</button>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="pt-2 border-t border-gray-800">
                  <textarea rows={2} value={newVerseInput} onChange={(e) => setNewVerseInput(e.target.value)} className="w-full bg-[#1f2937] rounded p-2 text-xs" placeholder="Novo verso..." />
                  <div className="flex gap-2 mt-2"><button onClick={() => { if(newVerseInput.trim()){ setSavedVerses(p => [newVerseInput.trim(), ...p]); setNewVerseInput(''); } }} className="py-2 px-3 bg-gray-800 rounded">Adicionar</button></div>
                </div>
              </div>
            )}

            {activeTab === 'style' && (
              <div className="space-y-4">
                <div className="bg-gray-900/50 p-3 rounded">
                  <div className="grid grid-cols-2 gap-3">
                    <div><label className="text-xs text-gray-400">Destaque</label><input type="color" value={theme.accent} onChange={(e) => setTheme(p => ({ ...p, accent: e.target.value }))} className="w-full"/></div>
                    <div><label className="text-xs text-gray-400">Fundo</label><input type="color" value={theme.bg} onChange={(e) => setTheme(p => ({ ...p, bg: e.target.value }))} className="w-full"/></div>
                  </div>
                </div>

                <div>
                  <div className="mb-2 text-xs font-bold text-gray-400">Tamanhos</div>
                  <RangeControl label="T√≠tulo (Fonte)" value={scales.mainTitleSize} onChange={(v) => handleScaleChange('mainTitleSize', v)} min={50} max={200} color={theme.accent} />
                  <RangeControl label="Frase (Fonte)" value={scales.subtitleSize} onChange={(v) => handleScaleChange('subtitleSize', v)} min={50} max={200} color={theme.accent} />
                </div>
              </div>
            )}

            {activeTab === 'images' && (
              <div className="space-y-3">
                <div>
                  <label className="text-xs text-gray-400">Logo</label>
                  <input type="file" onChange={(e) => handleUpload(e, 'logo')} />
                </div>
                <div>
                  <label className="text-xs text-gray-400">Fundo</label>
                  <input type="file" onChange={(e) => handleUpload(e, 'bg')} />
                  <RangeControl label="Opacidade" value={bgConfig.opacity} onChange={(v) => setBgConfig(p => ({ ...p, opacity: v }))} min={0} max={100} color={theme.accent} />
                </div>
              </div>
            )}
          </div>

          <div className="p-4 border-t border-gray-800 bg-[#0e1422]">
            <div className="grid grid-cols-2 gap-2">
              <button onClick={downloadArtwork} className="w-full py-3 rounded-lg font-bold text-xs bg-gradient-to-r from-green-600 to-green-500 text-white">BAIXAR ARTE</button>
              <button onClick={resetAll} className="w-full py-3 rounded-lg font-bold text-xs bg-gray-800">RESET</button>
            </div>
          </div>
        </div>

        <div className="flex-1 bg-black/50 relative flex items-center justify-center p-4" ref={containerRef}>
          <div style={{ width: FORMATS[format].dims.width * previewScale, height: FORMATS[format].dims.height * previewScale, position: 'relative' }} className="ring-1 ring-gray-800 transition-all duration-200">
            <div style={{ width: FORMATS[format].dims.width, height: FORMATS[format].dims.height, transform: \`scale(\${previewScale})\`, transformOrigin: 'top left', position: 'absolute', top: 0, left: 0 }}>
              <CanvasArtwork
                ref={artworkRef}
                format={format}
                theme={theme}
                texts={texts}
                scales={scales}
                images={images}
                bgConfig={bgConfig}
                onElementMove={handleMoveElement}
                onElementResize={handleResizeElement}
                onElementFontSize={handleFontSizeElement}
                isExporting={isExporting}
                onEditElement={startEditing}
              />
            </div>
          </div>

          {editingId && (
            <div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-6">
              <div className="bg-[#1f2937] border border-gray-600 rounded-xl p-6 w-full max-w-lg">
                <h3 className="text-white font-bold mb-4">EDITAR TEXTO</h3>
                <textarea rows={5} value={tempText} onChange={(e) => setTempText(e.target.value)} className="w-full bg-black/30 border border-gray-600 rounded-lg p-4 text-white text-lg" />
                <div className="flex justify-end gap-3 mt-4">
                  <button onClick={() => setEditingId(null)} className="px-4 py-2 rounded bg-gray-700 text-sm">CANCELAR</button>
                  <button onClick={saveEditing} className="px-6 py-2 rounded bg-yellow-400 text-black font-bold">SALVAR</button>
                </div>
              </div>
            </div>
          )}
        </div>

      </div>
    );
  }

  // Helper for changing scales receiving string/integer
  function handleScaleChange(key, value) {
    // This function will be bound later by setState closures; for single-file we rely on individual setters within App.
  }

  // Render
  ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
