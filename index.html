import React, { useState, useRef, useEffect, useCallback, useMemo } from 'react';
import { 
  Instagram, Save, UploadCloud, Smartphone, Square, RotateCcw, 
  Type, Image as ImageIcon, Wallpaper, Download, Clock, MapPin, 
  ChevronDown, Trash2, Loader2, LayoutTemplate, Palette, 
  Move, AlignCenter, MousePointer2, Check, FileJson, 
  Maximize2, ArrowDownRight, SlidersHorizontal, Code, BookOpen, Plus, Play, RefreshCw, Terminal, AlertCircle, FileCode, WifiOff,
  Scaling, ArrowLeftRight, X, Edit3, Map as MapIcon, TextCursor, ZoomIn, Grid, FileUp, FileCode2,
  AlignLeft, ArrowRightLeft, Layers, ChevronRight, Sun
} from 'lucide-react';

/**
 * =================================================================================
 * CONFIGURAÇÕES GLOBAIS (v10.2 - Ultimate Polish)
 * =================================================================================
 */

const APP_VERSION = "10.2";
const STORAGE_KEY = "instadesign_v10_data";

const FORMATS = {
  story: {
    label: 'Story (9:16)',
    dims: { width: 1080, height: 1920 },
    aspectRatio: '9/16',
    logoBaseWidth: 650,
    titleSizeClass: 'text-[8.5rem]', 
    logoTextSizeClass: 'text-[9rem]',
    logoIconSizeClass: 'text-[10rem]',
    titleGap: 'gap-y-6', 
    padding: 'pt-32 pb-28 px-10',
    defaultPillY: -17,
    baseSizes: {
      preTitle: 40,
      mainTitle: 150,
      subtitle: 54,
      infoLabel: 24,
      infoValue: 72,
      footerTitle: 32, 
      footerAddr: 32   
    }
  },
  post: {
    label: 'Post (4:5)',
    dims: { width: 1080, height: 1350 },
    aspectRatio: '4/5',
    logoBaseWidth: 480,
    titleSizeClass: 'text-[7rem]',
    logoTextSizeClass: 'text-8xl',
    logoIconSizeClass: 'text-9xl',
    titleGap: 'gap-y-5', 
    padding: 'pt-28 pb-20 px-12',
    defaultPillY: -4, 
    baseSizes: {
      preTitle: 28,
      mainTitle: 120,
      subtitle: 40,
      infoLabel: 18,
      infoValue: 48,
      footerTitle: 24, 
      footerAddr: 26   
    }
  }
};

const INITIAL_THEME = {
  accent: '#fbbf24', 
  bg: '#0e162b',     
  text: '#ffffff',
  // Glow Controls Independentes
  glowTopOpacity: 80,
  glowTopX: 80, // % position relative
  glowTopY: 20, // % position relative
  glowBottomOpacity: 60,
  glowBottomX: 20,
  glowBottomY: 90
};

const INITIAL_TEXTS = {
  preTitle: 'ESTUDO DA PALAVRA',
  mainTitle: 'ESCOLA\nBÍBLICA',
  subtitle: '"Venha crescer na graça e no conhecimento."',
  day: 'Toda Terça',
  time: '19h',
  footerTitle: 'IGREJA EVANGÉLICA ARCA',
  address: "Cond. Vivendas do Calembá.\nEst. dos Bandeirantes, 11.609 / Qd-04 Lt-54\nVargem Pequena, Rio de Janeiro/RJ"
};

const INITIAL_VERSES_LIST = [
  "Tua Palavra é lâmpada que ilumina os meus passos e luz que clareia o meu caminho! (Sl 119:105)",
  "Toda Escritura é dada pela inspiração de Deus... (2Tm 3:16)",
  "Estes foram mais nobres do que os de Tessalônica... (At 17:11)",
  "Porque o SENHOR dá a sabedoria... (Pv 2:6)",
  "Este livro da lei não se apartará de tua boca... (Js 1:8)",
  "Quanto amo a tua Lei! Sobre ela reflito o dia inteira! (Sl 119:97)",
  "A exposição das tuas palavras ilumina e dá entendimento aos inexperientes! (Sl 119:130)"
];

const FALLBACK_VERSES = [
    "O Senhor é o meu pastor; de nada terei falta. (Salmos 23:1)",
    "Tudo posso naquele que me fortalece. (Filipenses 4:13)",
    "Mas os que esperam no Senhor renovarão as forças. (Isaías 40:31)",
    "Busquem, pois, em primeiro lugar o Reino de Deus. (Mateus 6:33)",
    "Confie no Senhor de todo o coração. (Provérbios 3:5)"
];

const BASE_SCALES_TEMPLATE = {
  logo: 100, logoX: 0, logoY: 0,
  preTitle: 100, preTitleX: 0, preTitleY: 0, preTitleSize: 100, preTitleWidth: 100,
  mainTitle: 100, mainTitleX: 0, mainTitleY: 0, mainTitleSize: 100, mainTitleWidth: 100,
  subtitle: 100, subtitleX: 0, subtitleY: 0, subtitleWidth: 90, subtitleSize: 100,
  info: 100, infoTextSize: 100,
  footerTitle: 100, footerTitleX: 0, footerTitleY: 0, footerTitleSize: 100, footerTitleWidth: 100,
  footerAddr: 100, footerAddrX: 0, footerAddrY: 0, footerAddrSize: 100, footerAddrWidth: 100,
  shadowBlur: 20, pillPadding: 36, pillTitleTop: 28, pillIconY: 0,
  pillX: 0, pillY: 0, pillTextX: 0, pillTextY: -17,
  footerX: 0, footerY: 0
};

const INITIAL_BG = { opacity: 50, scale: 100, x: 0, y: 0 };

class ErrorBoundary extends React.Component {
  constructor(props) { super(props); this.state = { hasError: false, error: null }; }
  static getDerivedStateFromError(error) { return { hasError: true, error }; }
  componentDidCatch(error, errorInfo) { console.error("ErrorBoundary:", error, errorInfo); }
  render() {
    if (this.state.hasError) return <div className="p-4 bg-red-900 text-white rounded">Erro crítico. Recarregue a página.</div>;
    return this.props.children; 
  }
}

/**
 * =================================================================================
 * COMPONENTE: DRAGGABLE ITEM
 * =================================================================================
 */
const DraggableItem = ({ 
    children, x, y, scaleVal, fontSizeVal, widthVal,
    onMove, onScale, onFontSize, onWidth, onEdit, onSelect, onDragStatus,
    id, className = "", disabled = false, 
    fitContent = true, scaleFactor = 1, isSelected = false
  }) => {
    const [isHovered, setIsHovered] = useState(false);
    
    // Estados visuais locais para feedback imediato
    const [isResizingWidthVisual, setIsResizingWidthVisual] = useState(false);
    
    const isDragging = useRef(false);
    const isResizingScale = useRef(false);
    const isResizingFont = useRef(false);
    const isResizingWidth = useRef(false);
    
    const startPos = useRef({ x: 0, y: 0 });
    const startValues = useRef({ x: 0, y: 0, scale: 100, font: 100, width: 100 });
  
    useEffect(() => {
      return () => {
        document.removeEventListener('pointermove', handlePointerMove);
        document.removeEventListener('pointerup', handlePointerUp);
      };
    }, []);
  
    const handlePointerMove = (e) => {
      if (e.cancelable && (isDragging.current || isResizingScale.current || isResizingFont.current || isResizingWidth.current)) {
          e.preventDefault();
      }
  
      const safeScale = Math.max(0.1, scaleFactor || 1);
  
      if (isDragging.current) {
          const deltaX = (e.clientX - startPos.current.x) / safeScale; 
          const deltaY = (e.clientY - startPos.current.y) / safeScale;
          
          let newX = Math.round(startValues.current.x + deltaX);
          let newY = Math.round(startValues.current.y + deltaY);

          // Snap magnético suave (feedback visual na main app)
          if (Math.abs(newX) < 5) newX = 0;

          if(onMove) onMove(newX, newY);
  
      } else if (isResizingScale.current) {
          const deltaX = (e.clientX - startPos.current.x);
          const deltaY = (e.clientY - startPos.current.y);
          const movement = (deltaX + deltaY) / safeScale;
          let newScale = Math.round(Math.max(20, Math.min(400, startValues.current.scale + (movement * 0.8))));
          if(onScale) onScale(newScale);
  
      } else if (isResizingFont.current) {
          const deltaY = (e.clientY - startPos.current.y); 
          const movement = (-deltaY) / safeScale; 
          let newFont = Math.round(Math.max(20, Math.min(300, startValues.current.font + (movement * 1.5))));
          if (onFontSize) onFontSize(newFont);

      } else if (isResizingWidth.current) {
          const deltaX = (e.clientX - startPos.current.x);
          const movement = (-deltaX) / safeScale;
          let newWidth = Math.round(Math.max(30, Math.min(100, startValues.current.width + (movement * 0.2))));
          if(onWidth) onWidth(newWidth);
      }
    };
  
    const handlePointerUp = (e) => {
      isDragging.current = false;
      isResizingScale.current = false;
      isResizingFont.current = false;
      isResizingWidth.current = false;
      
      setIsResizingWidthVisual(false);
      if(onDragStatus) onDragStatus(false);

      if (e.target && e.target.releasePointerCapture) { try { e.target.releasePointerCapture(e.pointerId); } catch(err){} }
      document.removeEventListener('pointermove', handlePointerMove);
      document.removeEventListener('pointerup', handlePointerUp);
    };
  
    const handlePointerDownDrag = (e) => {
      if (disabled || isResizingScale.current || isResizingFont.current || isResizingWidth.current) return;
      if (e.button && e.button !== 0) return;
      e.stopPropagation();
      e.target.setPointerCapture(e.pointerId);
      
      if (onSelect) onSelect(id);
      if (onDragStatus) onDragStatus(true); // Avisa que começou a arrastar

      isDragging.current = true;
      startPos.current = { x: e.clientX, y: e.clientY };
      startValues.current = { x, y };
      document.addEventListener('pointermove', handlePointerMove, { passive: false });
      document.addEventListener('pointerup', handlePointerUp);
    };
  
    const handlePointerDownScale = (e) => { if (disabled) return; e.stopPropagation(); e.preventDefault(); e.target.setPointerCapture(e.pointerId); isResizingScale.current = true; startPos.current = { x: e.clientX, y: e.clientY }; startValues.current = { scale: scaleVal || 100 }; document.addEventListener('pointermove', handlePointerMove, { passive: false }); document.addEventListener('pointerup', handlePointerUp); };
    const handlePointerDownFont = (e) => { if (disabled) return; e.stopPropagation(); e.preventDefault(); e.target.setPointerCapture(e.pointerId); isResizingFont.current = true; startPos.current = { x: e.clientX, y: e.clientY }; startValues.current = { font: fontSizeVal || 100 }; document.addEventListener('pointermove', handlePointerMove, { passive: false }); document.addEventListener('pointerup', handlePointerUp); };
    
    const handlePointerDownWidth = (e) => { 
        if (disabled) return; 
        e.stopPropagation(); 
        e.preventDefault(); 
        e.target.setPointerCapture(e.pointerId); 
        isResizingWidth.current = true; 
        setIsResizingWidthVisual(true); // Ativa o frame visual
        startPos.current = { x: e.clientX, y: e.clientY }; 
        startValues.current = { width: widthVal || 100 }; 
        document.addEventListener('pointermove', handlePointerMove, { passive: false }); 
        document.addEventListener('pointerup', handlePointerUp); 
    };

    const showHandles = (isHovered || isSelected) && !disabled;
  
    return (
      <div 
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
        onPointerDown={handlePointerDownDrag}
        onDoubleClick={() => onEdit && onEdit(id)}
        className={`${className} ${disabled ? '' : 'group relative z-10'}`} 
        style={{ transform: `translate(${x}px, ${y}px)`, touchAction: 'none', width: fitContent ? 'max-content' : 'auto', maxWidth: '100%', display: 'flex', justifyContent: 'center', alignItems: 'center', cursor: isDragging.current ? 'grabbing' : 'grab' }}
      >
        <div className={`transition-all duration-200 relative ${showHandles ? 'ring-1 ring-blue-400/50 bg-blue-500/10 rounded-lg' : ''} ${isResizingWidthVisual ? 'ring-2 ring-purple-500 ring-dashed bg-purple-500/10' : ''}`}>
            {children}
            {showHandles && (
                <>
                  {onScale && <div onPointerDown={handlePointerDownScale} className="absolute -bottom-4 -right-4 w-7 h-7 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center cursor-nwse-resize hover:scale-110 active:scale-95 transition-transform z-50 border-2 border-white touch-none" title="Zoom"><Scaling className="w-3.5 h-3.5" /></div>}
                  {onFontSize && <div onPointerDown={handlePointerDownFont} className="absolute -top-4 -right-4 w-7 h-7 bg-yellow-500 text-black rounded-full shadow-xl flex items-center justify-center cursor-ns-resize hover:scale-110 active:scale-95 transition-transform z-50 border-2 border-white touch-none" title="Tamanho Fonte"><Type className="w-3.5 h-3.5" /></div>}
                  {onWidth && <div onPointerDown={handlePointerDownWidth} className="absolute -bottom-4 -left-4 w-7 h-7 bg-purple-600 text-white rounded-full shadow-xl flex items-center justify-center cursor-ew-resize hover:scale-110 active:scale-95 transition-transform z-50 border-2 border-white touch-none" title="Largura"><ArrowRightLeft className="w-3.5 h-3.5" /></div>}
                </>
            )}
        </div>
      </div>
    );
};

export default function App() { return <ErrorBoundary><MainApp /></ErrorBoundary>; }

function MainApp() {
  const [format, setFormat] = useState('story');
  const [theme, setTheme] = useState({ ...INITIAL_THEME });
  const [texts, setTexts] = useState({ ...INITIAL_TEXTS });
  const [scales, setScales] = useState({ story: { ...BASE_SCALES_TEMPLATE, pillY: FORMATS.story.defaultPillY }, post: { ...BASE_SCALES_TEMPLATE, pillY: FORMATS.post.defaultPillY } });
  const [images, setImages] = useState({ logo: null, bg: null });
  const [bgConfig, setBgConfig] = useState({ ...INITIAL_BG });
  const [savedVerses, setSavedVerses] = useState([...INITIAL_VERSES_LIST]);
  const [newVerseInput, setNewVerseInput] = useState("");
  const [isLoadingVerse, setIsLoadingVerse] = useState(false);
  const [activeTab, setActiveTab] = useState('texts');
  const [previewScale, setPreviewScale] = useState(1);
  const [isExporting, setIsExporting] = useState(false);
  const [isAutoSaved, setIsAutoSaved] = useState(false);
  const [selectedElementId, setSelectedElementId] = useState(null);
  const [editingId, setEditingId] = useState(null);
  const [tempText, setTempText] = useState("");
  const [isDraggingElement, setIsDraggingElement] = useState(false);

  const artworkRef = useRef(null);
  const containerRef = useRef(null);
  const fileInputLogo = useRef(null);
  const fileInputBg = useRef(null);
  const fileInputConfig = useRef(null);

  useEffect(() => {
      const savedData = localStorage.getItem(STORAGE_KEY);
      if (savedData) {
          try {
              const d = JSON.parse(savedData);
              if(d.texts) setTexts(d.texts);
              if(d.scales) { if (d.scales.story && d.scales.post) setScales(d.scales); else setScales({ story: { ...d.scales, pillY: FORMATS.story.defaultPillY }, post: { ...d.scales, pillY: FORMATS.post.defaultPillY } }); }
              if(d.theme) setTheme({ ...INITIAL_THEME, ...d.theme });
              if(d.format) setFormat(d.format);
              if(d.savedVerses) setSavedVerses(d.savedVerses);
              if(d.bgConfig) setBgConfig(d.bgConfig);
              if(d.images) setImages(d.images);
          } catch (e) { console.error("Erro load save", e); }
      }
  }, []);

  useEffect(() => {
      const timeout = setTimeout(() => {
          const data = { format, theme, texts, scales, images, bgConfig, savedVerses, version: APP_VERSION };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          setIsAutoSaved(true);
          setTimeout(() => setIsAutoSaved(false), 2000);
      }, 1500);
      return () => clearTimeout(timeout);
  }, [format, theme, texts, scales, images, bgConfig, savedVerses]);

  const handleTextChange = useCallback((key, value) => { setTexts(p => ({ ...p, [key]: value })); }, []);
  const updateCurrentScale = useCallback((key, value) => { setScales(prev => ({ ...prev, [format]: { ...prev[format], [key]: parseInt(value) } })); }, [format]);
  const handleScaleChange = useCallback((key, value) => { updateCurrentScale(key, value); }, [updateCurrentScale]);
  
  const handleMoveElement = useCallback((element, newX, newY) => {
    setScales(prev => {
        const currentFmt = prev[format];
        if (currentFmt[`${element}X`] === newX && currentFmt[`${element}Y`] === newY) return prev;
        return { ...prev, [format]: { ...currentFmt, [`${element}X`]: newX, [`${element}Y`]: newY, ...(element === 'pill' ? { pillX: newX, pillY: newY } : {}) } };
    });
  }, [format]);

  const handleResizeElement = useCallback((element, newScale) => { if (element === 'pill') updateCurrentScale('info', newScale); else updateCurrentScale(element, newScale); }, [updateCurrentScale]);
  const handleFontSizeElement = useCallback((element, newSize) => { const key = element === 'info' ? 'infoTextSize' : `${element}Size`; updateCurrentScale(key, newSize); }, [updateCurrentScale]);
  const handleWidthElement = useCallback((element, newWidth) => { updateCurrentScale(`${element}Width`, newWidth); }, [updateCurrentScale]);
  const handleSelectElement = useCallback((id) => { setSelectedElementId(id); }, []);
  const handleBackgroundClick = useCallback(() => { setSelectedElementId(null); }, []);

  const handleUploadConfig = (e) => {
      const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
      reader.onload = (ev) => {
          try {
              const d = JSON.parse(ev.target.result);
              if (d.format) setFormat(d.format); if (d.theme) setTheme(d.theme); if (d.texts) setTexts(d.texts);
              if (d.scales) { if (d.scales.story && d.scales.post) setScales(d.scales); else setScales({ story: { ...d.scales }, post: { ...d.scales } }); }
              if (d.bgConfig) setBgConfig(d.bgConfig); if (d.savedVerses) setSavedVerses(d.savedVerses);
              if (d.logo && d.logo.src) setImages(p => ({...p, logo: d.logo.src})); if (d.bg && d.bg.src) setImages(p => ({...p, bg: d.bg.src}));
              alert("Backup carregado!");
          } catch (err) { alert("Erro ao ler arquivo."); }
      }; reader.readAsText(file); e.target.value = '';
  };

  const downloadConfigJSON = async () => {
      const configData = { version: APP_VERSION, format, theme, texts, scales, bgConfig, savedVerses, logo: { src: images.logo }, bg: { src: images.bg } };
      const blob = new Blob([JSON.stringify(configData, null, 2)], {type : 'application/json'});
      const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `InstaDesign-Config-v${APP_VERSION}.json`; link.click();
  };

  const downloadAppSource = async () => {
      if(!window.JSZip) { alert("Carregando bibliotecas..."); return; }
      const zip = new window.JSZip();
      zip.file(`InstaDesign_v${APP_VERSION}_App.html`, document.documentElement.outerHTML);
      const content = await zip.generateAsync({ type: "blob" });
      const link = document.createElement('a'); link.href = URL.createObjectURL(content); link.download = `App-InstaDesign-v${APP_VERSION}.zip`; link.click();
  };

  const startEditing = (id) => {
      if (id === 'logo' || id === 'pill') return;
      if (texts.hasOwnProperty(id)) { setTempText(texts[id]); setEditingId(id); }
      else if (id === 'footerTitle') { setTempText(texts.footerTitle); setEditingId('footerTitle'); }
      else if (id === 'footerAddr') { setTempText(texts.address); setEditingId('address'); }
      else if (id === 'day') { setTempText(texts.day); setEditingId('day'); }
      else if (id === 'time') { setTempText(texts.time); setEditingId('time'); }
  };

  const saveEditing = () => {
      if (editingId) { handleTextChange(editingId, tempText); setEditingId(null); }
  };

  const downloadArtwork = async () => {
    if (!artworkRef.current || !window.html2canvas) return;
    setSelectedElementId(null); setIsExporting(true);
    await new Promise(r => setTimeout(r, 300));
    try {
        await downloadConfigJSON();
        const timestamp = Date.now();
        const element = artworkRef.current;
        const clone = element.cloneNode(true);
        const wrapper = document.createElement('div');
        Object.assign(wrapper.style, { position: 'fixed', left: '-9999px', top: '0', width: `${FORMATS[format].dims.width}px`, height: `${FORMATS[format].dims.height}px`, zIndex: '-9999' });
        clone.style.transform = 'none'; wrapper.appendChild(clone); document.body.appendChild(wrapper);
        const canvas = await window.html2canvas(clone, { scale: 2, useCORS: true, allowTaint: true, width: FORMATS[format].dims.width, height: FORMATS[format].dims.height, backgroundColor: theme.bg });
        const imgLink = document.createElement('a'); imgLink.download = `InstaDesign-v${APP_VERSION}-${format}-${timestamp}.jpg`; imgLink.href = canvas.toDataURL('image/jpeg', 0.95); imgLink.click();
        document.body.removeChild(wrapper);
    } catch (err) { alert("Erro na exportação."); } finally { setIsExporting(false); }
  };

  const resetAll = () => {
    if (!window.confirm("ATENÇÃO: Resetar tudo?")) return;
    setTexts({ ...INITIAL_TEXTS });
    setScales({ story: { ...BASE_SCALES_TEMPLATE, pillY: FORMATS.story.defaultPillY }, post: { ...BASE_SCALES_TEMPLATE, pillY: FORMATS.post.defaultPillY } });
    setBgConfig({ ...INITIAL_BG }); setTheme({ ...INITIAL_THEME }); setImages({ logo: null, bg: null });
  };

  useEffect(() => {
    const handleResize = () => {
       if (!containerRef.current) return;
       const parent = containerRef.current;
       const dim = FORMATS[format].dims;
       let s = Math.min((parent.clientWidth - 40) / dim.width, (parent.clientHeight - 40) / dim.height);
       setPreviewScale(Math.max(0.1, Math.min(s, 0.95)));
    };
    window.addEventListener('resize', handleResize); setTimeout(handleResize, 100); return () => window.removeEventListener('resize', handleResize);
  }, [format]);

  const currentScales = scales[format] || scales.story;

  return (
    <div className="bg-[#0b0f19] text-gray-100 h-screen flex flex-col md:flex-row overflow-hidden font-sans selection:bg-yellow-500/30">
       <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Playfair+Display:ital,wght@1,600&display=swap');
        .font-serif { font-family: 'Playfair Display', serif; }
        .font-sans { font-family: 'Montserrat', sans-serif; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 2px; }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: ${theme.accent}; cursor: pointer; margin-top: -5px; box-shadow: 0 0 4px rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 2px; cursor: pointer; background: #374151; }
      `}</style>
      <ScriptLoader />
      <input type="file" ref={fileInputConfig} onChange={handleUploadConfig} accept=".json" className="hidden" />

      <Sidebar 
         activeTab={activeTab} setActiveTab={setActiveTab} format={format} setFormat={setFormat}
         texts={texts} handleTextChange={handleTextChange} scales={currentScales} handleScaleChange={handleScaleChange}
         theme={theme} setTheme={setTheme} images={images} setImages={setImages} bgConfig={bgConfig} setBgConfig={setBgConfig}
         fileRefs={{ logo: fileInputLogo, bg: fileInputBg }}
         actions={{ downloadArtwork, downloadAppSource, downloadConfigJSON, triggerUpload: () => fileInputConfig.current.click(), resetAll }}
         isExporting={isExporting} isAutoSaved={isAutoSaved}
         savedVerses={savedVerses} setSavedVerses={setSavedVerses} setNewVerseInput={setNewVerseInput} newVerseInput={newVerseInput} isLoadingVerse={isLoadingVerse} setIsLoadingVerse={setIsLoadingVerse}
      />

      <div className="flex-1 bg-black/50 relative flex items-center justify-center p-4 md:p-8 overflow-hidden h-[60%] md:h-full" ref={containerRef}>
         <div className="absolute inset-0 opacity-20 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#374151 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>
         <div className="absolute inset-0" onClick={handleBackgroundClick}></div>
         <div style={{ width: FORMATS[format].dims.width * previewScale, height: FORMATS[format].dims.height * previewScale, position: 'relative', boxShadow: '0 20px 50px rgba(0,0,0,0.5)' }} className="ring-1 ring-gray-800 transition-all duration-200 pointer-events-none">
            <div className="pointer-events-auto" style={{ width: FORMATS[format].dims.width, height: FORMATS[format].dims.height, transform: `scale(${previewScale})`, transformOrigin: 'top left', position: 'absolute', top: 0, left: 0 }}>
                <CanvasArtwork 
                    ref={artworkRef} format={format} theme={theme} texts={texts} scales={currentScales} images={images} bgConfig={bgConfig}
                    previewScale={previewScale} onElementMove={handleMoveElement} onElementResize={handleResizeElement} onElementFontSize={handleFontSizeElement}
                    onElementWidth={handleWidthElement} onDragStatus={setIsDraggingElement}
                    isExporting={isExporting} onEditElement={startEditing} selectedElementId={selectedElementId} onSelectElement={handleSelectElement}
                    isDraggingElement={isDraggingElement} // PASSA O STATUS
                />
            </div>
         </div>
         {editingId && (
             <div className="absolute inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
                 <div className="bg-[#1f2937] border border-gray-600 rounded-xl p-6 w-full max-w-lg shadow-2xl animate-in fade-in zoom-in duration-200">
                     <h3 className="text-white font-bold mb-4 flex items-center gap-2"><Edit3 className="w-5 h-5 text-[#fbbf24]" /> EDITAR TEXTO</h3>
                     <textarea rows={5} className="w-full bg-black/30 border border-gray-600 rounded-lg p-4 text-white text-lg focus:border-[#fbbf24] outline-none resize-none mb-4" value={tempText} onChange={(e) => setTempText(e.target.value)} autoFocus />
                     <div className="flex justify-end gap-3"><button onClick={() => setEditingId(null)} className="px-4 py-2 rounded-lg text-gray-300 hover:bg-white/10 font-bold">CANCELAR</button><button onClick={saveEditing} className="px-6 py-2 rounded-lg bg-[#fbbf24] hover:bg-yellow-500 text-black font-bold flex items-center gap-2"><Check className="w-4 h-4" /> SALVAR</button></div>
                 </div>
             </div>
         )}
      </div>
    </div>
  );
}

const ScriptLoader = () => {
    useEffect(() => {
        const loadScript = (src) => { if(!document.querySelector(`script[src="${src}"]`)) { const s = document.createElement('script'); s.src = src; s.async = true; document.body.appendChild(s); }};
        loadScript("https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js");
        loadScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js");
    }, []);
    return null;
}

// COMPONENTE COLAPSÁVEL
const CollapseGroup = ({ title, children, defaultOpen = false }) => {
    const [isOpen, setIsOpen] = useState(defaultOpen);
    return (
        <div className="border border-gray-800 rounded-lg bg-[#0e1422] overflow-hidden">
            <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-3 bg-[#111827] hover:bg-[#1f2937] transition-colors text-[10px] font-bold text-gray-300 uppercase tracking-wider">
                <span className="flex items-center gap-2">{title}</span>
                <ChevronRight className={`w-3 h-3 transition-transform duration-200 ${isOpen ? 'rotate-90' : ''}`} />
            </button>
            {isOpen && <div className="p-3 border-t border-gray-800 space-y-3 bg-[#0b0f19]">{children}</div>}
        </div>
    );
};

function Sidebar({ activeTab, setActiveTab, format, setFormat, texts, handleTextChange, scales, handleScaleChange, theme, setTheme, images, setImages, bgConfig, setBgConfig, fileRefs, actions, isExporting, savedVerses, setSavedVerses, newVerseInput, setNewVerseInput, isLoadingVerse, setIsLoadingVerse }) {
    const handleUpload = (e, type) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => setImages(prev => ({ ...prev, [type]: ev.target.result })); reader.readAsDataURL(file); }};
    const fetchRandomVerse = async () => {
        setIsLoadingVerse(true);
        try {
            const res = await fetch('https://www.abibliadigital.com.br/api/verses/nvi/random');
            if(!res.ok) throw new Error();
            const data = await res.json();
            const verseText = `"${data.text}"\n(${data.book.name} ${data.chapter}:${data.number})`;
            setSavedVerses(p => [verseText, ...p]);
            handleTextChange('subtitle', verseText);
        } catch {
             const fallback = FALLBACK_VERSES[Math.floor(Math.random() * FALLBACK_VERSES.length)];
             setSavedVerses(p => [fallback, ...p]);
             handleTextChange('subtitle', fallback);
        } finally { setIsLoadingVerse(false); }
    };
    const handleAddVerse = () => {
        if (!newVerseInput || newVerseInput.trim() === '') return;
        setSavedVerses(p => [newVerseInput.trim(), ...p]);
        handleTextChange('subtitle', newVerseInput.trim());
        setNewVerseInput('');
    };

    return (
        <div className="w-full md:w-[360px] flex-shrink-0 bg-[#0b0f19] border-r border-gray-800 flex flex-col h-[45%] md:h-full z-20">
             <div className="p-3 border-b border-gray-800 flex items-center justify-between bg-[#0e1422] relative">
                <div className="flex flex-col">
                    <div className="flex items-center gap-1.5 opacity-90"><div className="w-6 h-6 rounded bg-gradient-to-br from-pink-500 to-yellow-500 flex items-center justify-center text-white shadow shadow-orange-500/20"><Instagram className="w-3.5 h-3.5" /></div><h1 className="text-xs font-black text-gray-200 tracking-wider">App InstaDesign</h1></div>
                    <p className="text-[8px] text-gray-500 font-mono tracking-tighter leading-none mt-0.5 ml-8">v{APP_VERSION} PRO</p>
                </div>
                <div className="flex gap-1 z-10">
                     <button onClick={actions.triggerUpload} title="Carregar Backup" className="p-2 hover:bg-gray-800 rounded text-blue-400 border border-transparent hover:border-gray-700 transition-all"><UploadCloud className="w-4 h-4" /></button>
                     <button onClick={actions.downloadConfigJSON} title="Salvar Backup (JSON)" className="p-2 hover:bg-gray-800 rounded text-green-400 border border-transparent hover:border-gray-700 transition-all"><FileJson className="w-4 h-4" /></button>
                     <button onClick={actions.resetAll} title="Resetar Tudo" className="p-2 hover:bg-red-900/30 rounded text-red-500 border border-transparent hover:border-red-900 transition-all"><Trash2 className="w-4 h-4" /></button>
                </div>
            </div>
            <div className="p-2 grid grid-cols-2 gap-2 bg-[#0b0f19]">
                <FormatBtn active={format === 'story'} onClick={() => setFormat('story')} icon={<Smartphone className="w-3 h-3" />} label="Story" color={theme.accent} />
                <FormatBtn active={format === 'post'} onClick={() => setFormat('post')} icon={<Square className="w-3 h-3" />} label="Post" color={theme.accent} />
            </div>
            <div className="flex border-b border-gray-800">
                <TabBtn id="texts" active={activeTab} onClick={setActiveTab} icon={<Type className="w-3 h-3" />} label="Texto" color={theme.accent}/>
                <TabBtn id="images" active={activeTab} onClick={setActiveTab} icon={<ImageIcon className="w-3 h-3" />} label="Mídia" color={theme.accent}/>
                <TabBtn id="style" active={activeTab} onClick={setActiveTab} icon={<Palette className="w-3 h-3" />} label="Estilo" color={theme.accent}/>
                <TabBtn id="verses" active={activeTab} onClick={setActiveTab} icon={<BookOpen className="w-3 h-3" />} label="Versos" color={theme.accent}/>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-5 custom-scrollbar">
                {activeTab === 'texts' && (
                     <div className="space-y-4">
                        <InputGroup label="Tag Superior" value={texts.preTitle} onChange={v => handleTextChange('preTitle', v)} />
                        <InputGroup label="Título Principal" value={texts.mainTitle} onChange={v => handleTextChange('mainTitle', v)} isArea rows={3} placeholder="Digite o título..." />
                        <InputGroup label="Texto de Apoio" value={texts.subtitle} onChange={v => handleTextChange('subtitle', v)} isArea rows={3} />
                        <div className="pt-4 border-t border-gray-800 space-y-3">
                             <SectionTitle icon={<Clock />} title="Data e Hora" />
                             <div className="grid grid-cols-2 gap-2"><InputGroup label="Data" value={texts.day} onChange={v => handleTextChange('day', v)} /><InputGroup label="Horário" value={texts.time} onChange={v => handleTextChange('time', v)} /></div>
                             <div className="mt-4 pt-4 border-t border-gray-800">
                                 <SectionTitle icon={<MapIcon />} title="Rodapé / Institucional" />
                                 <InputGroup label="Instituição" value={texts.footerTitle} onChange={v => handleTextChange('footerTitle', v)} />
                                 <InputGroup label="Localização" value={texts.address} onChange={v => handleTextChange('address', v)} isArea rows={3} />
                             </div>
                        </div>
                     </div>
                )}
                {activeTab === 'style' && (
                    <div className="space-y-4">
                        <CollapseGroup title="Cores & Luz" defaultOpen={true}>
                            <div className="grid grid-cols-2 gap-3 mb-2">
                                <div><label className="text-[10px] text-gray-500 font-bold block mb-1 text-left ml-1">DESTAQUE</label><input type="color" value={theme.accent} onChange={e => setTheme(p => ({...p, accent: e.target.value}))} className="w-full h-8 rounded cursor-pointer bg-transparent border-none p-0" /></div>
                                <div><label className="text-[10px] text-gray-500 font-bold block mb-1 text-left ml-1">FUNDO</label><input type="color" value={theme.bg} onChange={e => setTheme(p => ({...p, bg: e.target.value}))} className="w-full h-8 rounded cursor-pointer bg-transparent border-none p-0" /></div>
                            </div>
                            <div className="pt-2 border-t border-gray-700/50 space-y-3">
                                <div>
                                    <div className="flex items-center justify-between mb-1"><label className="text-[9px] font-bold text-gray-400 flex items-center gap-1"><Sun className="w-3 h-3"/> LUZ SUPERIOR</label></div>
                                    <RangeControl label="Intensidade" value={theme.glowTopOpacity} onChange={v => setTheme(p => ({...p, glowTopOpacity: v}))} min={0} max={100} color={theme.accent} />
                                    <div className="grid grid-cols-2 gap-2 mt-1">
                                        <RangeControl label="X" value={theme.glowTopX} onChange={v => setTheme(p => ({...p, glowTopX: v}))} min={0} max={100} unit="%" displayValue={false} />
                                        <RangeControl label="Y" value={theme.glowTopY} onChange={v => setTheme(p => ({...p, glowTopY: v}))} min={0} max={100} unit="%" displayValue={false} />
                                    </div>
                                </div>
                                <div className="pt-2 border-t border-gray-700/30">
                                    <div className="flex items-center justify-between mb-1"><label className="text-[9px] font-bold text-gray-400 flex items-center gap-1"><Sun className="w-3 h-3"/> LUZ INFERIOR</label></div>
                                    <RangeControl label="Intensidade" value={theme.glowBottomOpacity} onChange={v => setTheme(p => ({...p, glowBottomOpacity: v}))} min={0} max={100} color={theme.accent} />
                                    <div className="grid grid-cols-2 gap-2 mt-1">
                                        <RangeControl label="X" value={theme.glowBottomX} onChange={v => setTheme(p => ({...p, glowBottomX: v}))} min={0} max={100} unit="%" displayValue={false} />
                                        <RangeControl label="Y" value={theme.glowBottomY} onChange={v => setTheme(p => ({...p, glowBottomY: v}))} min={0} max={100} unit="%" displayValue={false} />
                                    </div>
                                </div>
                            </div>
                        </CollapseGroup>

                        <CollapseGroup title="Posição: Logo e Box">
                            <div className="grid grid-cols-2 gap-2"><RangeControl label="Logo X" value={scales.logoX} onChange={v => handleScaleChange('logoX', v)} min={-300} max={300} displayValue={false} /><RangeControl label="Logo Y" value={scales.logoY} onChange={v => handleScaleChange('logoY', v)} min={-300} max={300} displayValue={false} /></div>
                            <div className="grid grid-cols-2 gap-2 mt-2"><RangeControl label="Box X" value={scales.pillX} onChange={v => handleScaleChange('pillX', v)} min={-300} max={300} displayValue={false} /><RangeControl label="Box Y" value={scales.pillY} onChange={v => handleScaleChange('pillY', v)} min={-300} max={300} displayValue={false} /></div>
                        </CollapseGroup>

                        <CollapseGroup title="Textos Gerais">
                            <div className="mb-3">
                                <label className="text-[9px] font-bold text-gray-500 uppercase block mb-1">Texto: Tag + Título</label>
                                <RangeControl label="Tag (Zoom)" value={scales.preTitle} onChange={v => handleScaleChange('preTitle', v)} color={theme.accent} />
                                <RangeControl label="Tag (Fonte)" value={scales.preTitleSize} onChange={v => handleScaleChange('preTitleSize', v)} color={theme.accent} min={50} max={200} />
                                <div className="h-2"></div>
                                <RangeControl label="Título (Zoom)" value={scales.mainTitle} onChange={v => handleScaleChange('mainTitle', v)} color={theme.accent} />
                                <RangeControl label="Título (Fonte)" value={scales.mainTitleSize} onChange={v => handleScaleChange('mainTitleSize', v)} color={theme.accent} min={50} max={200} />
                            </div>
                            <div className="pt-2 border-t border-gray-700/50">
                                <label className="text-[9px] font-bold text-gray-500 uppercase block mb-1 mt-2">Frase/Vers.</label>
                                <RangeControl label="Zoom" value={scales.subtitle} onChange={v => handleScaleChange('subtitle', v)} color={theme.accent} />
                                <RangeControl label="Largura" value={scales.subtitleWidth} onChange={v => handleScaleChange('subtitleWidth', v)} min={30} max={100} unit="%" color={theme.accent} />
                                <RangeControl label="Fonte" value={scales.subtitleSize} onChange={v => handleScaleChange('subtitleSize', v)} min={50} max={200} color={theme.accent} />
                            </div>
                        </CollapseGroup>

                        <CollapseGroup title="Rodapé">
                            <RangeControl label="Inst. (Fonte)" value={scales.footerTitleSize} onChange={v => handleScaleChange('footerTitleSize', v)} color={theme.accent} />
                            <RangeControl label="Local (Fonte)" value={scales.footerAddrSize} onChange={v => handleScaleChange('footerAddrSize', v)} color={theme.accent} />
                            <RangeControl label="Rodapé (Largura)" value={scales.footerWidth} onChange={v => handleScaleChange('footerWidth', v)} min={50} max={120} unit="%" color={theme.accent} />
                        </CollapseGroup>
                    </div>
                )}
                 {activeTab === 'images' && (
                    <div className="space-y-5">
                        <SectionTitle icon={<ImageIcon />} title="Mídia & Imagens" />
                        <div className="space-y-2"><label className="text-[10px] text-gray-500 font-bold block text-left ml-1">LOGO</label><input type="file" onChange={(e) => handleUpload(e, 'logo')} className="text-[10px] w-full text-gray-400" /></div>
                        <div className="space-y-2"><label className="text-[10px] text-gray-500 font-bold block text-left ml-1">FUNDO</label><input type="file" onChange={(e) => handleUpload(e, 'bg')} className="text-[10px] w-full text-gray-400" />
                            <RangeControl label="Opacidade" value={bgConfig.opacity} onChange={v => setBgConfig(p => ({...p, opacity: v}))} min={0} max={100} color={theme.accent} />
                            <RangeControl label="Zoom BG" value={bgConfig.scale} onChange={v => setBgConfig(p => ({...p, scale: v}))} min={100} max={300} color={theme.accent} />
                        </div>
                    </div>
                )}
                 {activeTab === 'verses' && (
                    <div className="space-y-4">
                        <button onClick={fetchRandomVerse} disabled={isLoadingVerse} className="w-full bg-blue-900/30 border border-blue-500/30 text-blue-200 hover:bg-blue-900/50 p-3 rounded-lg text-xs font-bold flex items-center justify-center gap-2">{isLoadingVerse ? <Loader2 className="w-3 h-3 animate-spin"/> : <RefreshCw className="w-3 h-3"/>} USAR VERSÍCULO ALEATÓRIO</button>
                        <div className="space-y-2 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar">{savedVerses.map((v, i) => (<div key={i} className="bg-gray-900 border border-gray-800 p-2 rounded group"><p className="text-[10px] text-gray-300 italic mb-2 line-clamp-3">"{v}"</p><div className="flex justify-end gap-2"><button onClick={() => setSavedVerses(p => p.filter((_, idx) => idx !== i))} className="p-1 text-red-400"><Trash2 className="w-3 h-3"/></button><button onClick={() => handleTextChange('subtitle', v)} className="px-2 py-1 bg-green-900/30 text-green-400 rounded text-[9px] font-bold">USAR</button></div></div>))}</div>
                        <div className="pt-2 border-t border-gray-800"><div className="flex gap-2"><textarea rows={2} value={newVerseInput} onChange={(e) => setNewVerseInput(e.target.value)} placeholder="Novo verso..." className="flex-1 bg-[#1f2937] border border-gray-700 rounded p-2 text-xs text-white focus:border-gray-500 outline-none resize-none" /><button onClick={handleAddVerse} className="bg-gray-800 hover:bg-gray-700 text-white p-2 rounded border border-gray-700"><Plus className="w-4 h-4" /></button></div></div>
                    </div>
                )}
            </div>
             <div className="p-4 border-t border-gray-800 bg-[#0e1422]">
                <div className="grid grid-cols-2 gap-2">
                    <button onClick={actions.downloadArtwork} disabled={isExporting} className="w-full py-3 rounded-lg font-bold text-xs shadow-lg flex items-center justify-center gap-2 bg-gradient-to-r from-green-600 to-green-500 text-white border border-green-500/30 hover:brightness-110">{isExporting ? <Loader2 className="w-4 h-4 animate-spin" /> : <Download className="w-4 h-4" />} BAIXAR ARTE</button>
                    <button onClick={actions.downloadAppSource} className="w-full py-3 rounded-lg font-bold text-xs text-blue-300 hover:text-blue-100 bg-blue-900/20 border border-blue-900/50 flex items-center justify-center gap-2"><FileCode2 className="w-4 h-4" /> BAIXAR FONTE</button>
                </div>
            </div>
        </div>
    );
}

const CanvasArtwork = React.forwardRef(({ format, theme, texts, scales, images, bgConfig, previewScale, onElementMove, onElementResize, onElementFontSize, onElementWidth, isDraggingElement, onDragStatus, isExporting, onEditElement, selectedElementId, onSelectElement }, ref) => {
    const fmt = FORMATS[format];
    const getFontSize = (base, scale) => `${base * (scale / 100)}px`;
    const logoStyle = useMemo(() => ({ width: fmt.logoBaseWidth * (scales.logo / 100) }), [fmt, scales.logo]);
    
    // Independent Glow Logic
    const topGlowOp = (theme.glowTopOpacity || 80) / 100;
    const botGlowOp = (theme.glowBottomOpacity || 60) / 100;
    
    const blurGold = { 
        background: `radial-gradient(circle, ${theme.accent} 0%, ${theme.accent}00 70%)`, 
        opacity: 0.8 * topGlowOp, 
        mixBlendMode: 'screen',
        left: `${theme.glowTopX || 80}%`,
        top: `${theme.glowTopY || 20}%`,
        transform: 'translate(-50%, -50%)' 
    };
    
    const blurBlue = { 
        background: `radial-gradient(circle, ${theme.bg} 0%, ${theme.bg}00 70%)`, 
        opacity: 0.6 * botGlowOp, 
        mixBlendMode: 'screen',
        left: `${theme.glowBottomX || 20}%`,
        top: `${theme.glowBottomY || 90}%`,
        transform: 'translate(-50%, -50%)'
    };

    // SNAP GUIDE LOGIC: Only show if dragging AND x is close to 0
    const showSnapX = isDraggingElement && selectedElementId && Math.abs(scales[selectedElementId + 'X']) === 0 && !isExporting;

    return (
        <div ref={ref} className={`w-full h-full relative overflow-hidden flex flex-col items-center text-center select-none ${isExporting ? 'exporting-mode' : ''}`} style={{ backgroundColor: theme.bg, color: theme.text }}>
            <div className="absolute inset-0 z-0" style={{ backgroundColor: theme.bg }}></div>
            {/* Background Image */}
            {images.bg && (<div className="absolute top-1/2 left-1/2 w-full h-full pointer-events-none z-0" style={{ transform: `translate(calc(-50% + ${bgConfig.x}%), calc(-50% + ${bgConfig.y}%)) scale(${bgConfig.scale / 100})`, opacity: bgConfig.opacity / 100 }}><div style={{ width: '100%', height: '100%', backgroundImage: `url(${images.bg})`, backgroundSize: 'cover', backgroundPosition: 'center', backgroundRepeat: 'no-repeat' }} /></div>)}
            
            {/* Enhanced Glow Effects */}
            <div className="absolute inset-0 z-0 pointer-events-none overflow-hidden">
                <div className="absolute w-[120%] h-[80%] rounded-full transition-all duration-300 blur-[100px]" style={blurGold}></div>
                <div className="absolute w-[100%] h-[70%] rounded-full transition-all duration-300 blur-[80px]" style={blurBlue}></div>
            </div>
            
            {/* Decorative Borders */}
            <div className="absolute top-12 left-10 w-20 h-20 border-t border-l rounded-tl-3xl opacity-60 z-10 pointer-events-none" style={{ borderColor: theme.accent }}></div>
            <div className="absolute bottom-12 right-10 w-20 h-20 border-b border-r rounded-br-3xl opacity-60 z-10 pointer-events-none" style={{ borderColor: theme.accent }}></div>

            {/* Snap Guide Line - Smart Visibility */}
            {showSnapX && (
                <div className="absolute top-0 bottom-0 left-1/2 w-0.5 bg-cyan-400/80 z-50 shadow-[0_0_8px_rgba(34,211,238,0.8)] pointer-events-none animate-in fade-in duration-200"></div>
            )}

            <div className={`relative z-20 w-full h-full flex flex-col justify-between ${fmt.padding}`}>
                <div className="flex-grow-[1] flex items-center justify-center relative">
                    <DraggableItem id="logo" x={scales.logoX} y={scales.logoY} scaleVal={scales.logo} fontSizeVal={scales.logo} scaleFactor={previewScale} onMove={(x, y) => onElementMove('logo', x, y)} onScale={(s) => onElementResize('logo', s)} onDragStatus={onDragStatus} disabled={isExporting} isSelected={selectedElementId === 'logo'} onSelect={onSelectElement}>
                        <div style={logoStyle} className="relative flex justify-center items-center drop-shadow-2xl">{images.logo ? <img src={images.logo} className="w-full h-auto object-contain drop-shadow-xl" alt="Logo" /> : <div className={`font-serif italic leading-none tracking-tighter ${fmt.logoTextSizeClass}`}><span style={{ color: theme.accent, fontFamily: 'Playfair Display' }} className={`relative z-10 ${fmt.logoIconSizeClass}`}>LOGO</span></div>}</div>
                    </DraggableItem>
                </div>
                <div className={`flex-grow-[2] flex flex-col items-center justify-center w-full ${fmt.titleGap}`}>
                    <DraggableItem id="preTitle" x={scales.preTitleX} y={scales.preTitleY} scaleVal={scales.preTitle} fontSizeVal={scales.preTitleSize} widthVal={scales.preTitleWidth} scaleFactor={previewScale} onMove={(x, y) => onElementMove('preTitle', x, y)} onScale={(s) => onElementResize('preTitle', s)} onFontSize={(s) => onElementFontSize('preTitle', s)} onWidth={(w) => onElementWidth('preTitle', w)} onDragStatus={onDragStatus} onEdit={onEditElement} disabled={isExporting} isSelected={selectedElementId === 'preTitle'} onSelect={onSelectElement}>
                        <div style={{ width: `${scales.preTitleWidth}%`, transform: `scale(${scales.preTitle/100})`, transformOrigin: 'center' }} className="flex items-center gap-4 justify-center mx-auto"><div className="h-[1px] w-8 opacity-60" style={{ background: theme.accent }}></div><h3 className="font-bold tracking-[0.25em] uppercase font-sans whitespace-nowrap" style={{ color: theme.accent, fontSize: getFontSize(fmt.baseSizes.preTitle, scales.preTitleSize || 100) }}>{texts.preTitle}</h3><div className="h-[1px] w-8 opacity-60" style={{ background: theme.accent }}></div></div>
                    </DraggableItem>
                    
                    <DraggableItem id="mainTitle" x={scales.mainTitleX} y={scales.mainTitleY} scaleVal={scales.mainTitle} fontSizeVal={scales.mainTitleSize} widthVal={scales.mainTitleWidth} scaleFactor={previewScale} onMove={(x, y) => onElementMove('mainTitle', x, y)} onScale={(s) => onElementResize('mainTitle', s)} onFontSize={(s) => onElementFontSize('mainTitle', s)} onWidth={(w) => onElementWidth('mainTitle', w)} onDragStatus={onDragStatus} onEdit={onEditElement} disabled={isExporting} isSelected={selectedElementId === 'mainTitle'} onSelect={onSelectElement}>
                        <div style={{ width: `${scales.mainTitleWidth}%`, transform: `scale(${scales.mainTitle/100})`, transformOrigin: 'center' }} className="mx-auto"><h1 className={`font-black leading-[0.85] tracking-tight text-shadow-sm font-sans uppercase text-white ${fmt.titleSizeClass}`} style={{ fontSize: getFontSize(fmt.baseSizes.mainTitle, scales.mainTitleSize || 100), whiteSpace: 'pre-line' }}>{texts.mainTitle}</h1></div>
                    </DraggableItem>
                    
                    {texts.subtitle && (
                        <DraggableItem id="subtitle" x={scales.subtitleX} y={scales.subtitleY} scaleVal={scales.subtitle} fontSizeVal={scales.subtitleSize} widthVal={scales.subtitleWidth} scaleFactor={previewScale} 
                            onMove={(x, y) => onElementMove('subtitle', x, y)} 
                            onScale={(s) => onElementResize('subtitle', s)} 
                            onFontSize={(s) => onElementFontSize('subtitle', s)}
                            onWidth={(w) => onElementWidth('subtitle', w)} 
                            onDragStatus={onDragStatus}
                            onEdit={onEditElement} disabled={isExporting} isSelected={selectedElementId === 'subtitle'} onSelect={onSelectElement} className="w-full flex justify-center">
                            <div style={{ width: `${scales.subtitleWidth}%`, transform: `scale(${scales.subtitle/100})`, transformOrigin: 'center' }} className="mx-auto">
                                <p className="text-gray-100 italic font-serif leading-snug opacity-90 drop-shadow-md text-center break-words" style={{ fontSize: getFontSize(fmt.baseSizes.subtitle, scales.subtitleSize || 100), whiteSpace: 'pre-wrap' }}>{texts.subtitle}</p>
                            </div>
                        </DraggableItem>
                    )}
                </div>
                <div className="flex-grow-[1] flex flex-col items-center justify-end relative">
                    <DraggableItem id="pill" x={scales.pillX} y={scales.pillY} scaleVal={scales.info} fontSizeVal={scales.infoTextSize} scaleFactor={previewScale} onMove={(x, y) => onElementMove('pill', x, y)} onScale={(s) => onElementResize('pill', s)} onDragStatus={onDragStatus} className="mb-0 relative z-30" disabled={isExporting} isSelected={selectedElementId === 'pill'} onSelect={onSelectElement}>
                        <div className="rounded-full border border-white/30 shadow-2xl backdrop-blur-lg overflow-hidden flex items-center relative" style={{ backgroundColor: 'rgba(255, 255, 255, 0.15)', transform: `scale(${scales.info / 100})`, padding: `${scales.pillPadding}px 2rem` }}>
                            <div className="rounded-full w-14 h-14 flex items-center justify-center shadow-lg mr-6 absolute left-4" style={{ backgroundColor: theme.accent, color: theme.bg, transform: `translateY(${scales.pillIconY}px)` }}><Clock className="w-8 h-8 stroke-[2.5]" /></div>
                            <div className="flex divide-x divide-white/20 pl-16" style={{ transform: `translate(${scales.pillTextX}px, ${scales.pillTextY}px)` }}>
                                <div onDoubleClick={(e) => { e.stopPropagation(); onEditElement('day'); }} className="px-6 pill-text-container text-left min-w-[160px] cursor-text hover:bg-white/5 rounded transition-colors"><p className="text-white/80 uppercase font-bold tracking-widest mb-1 text-[10px]" style={{ fontSize: getFontSize(fmt.baseSizes.infoLabel, scales.infoTextSize) }}>QUANDO</p><p className="font-bold text-white tracking-tight leading-none whitespace-nowrap" style={{ fontSize: getFontSize(fmt.baseSizes.infoValue, scales.infoTextSize) }}>{texts.day}</p></div>
                                <div onDoubleClick={(e) => { e.stopPropagation(); onEditElement('time'); }} className="px-6 pill-text-container text-left min-w-[120px] cursor-text hover:bg-white/5 rounded transition-colors"><p className="text-white/80 uppercase font-bold tracking-widest mb-1 text-[10px]" style={{ fontSize: getFontSize(fmt.baseSizes.infoLabel, scales.infoTextSize) }}>HORÁRIO</p><p className="font-bold text-white tracking-tight leading-none whitespace-nowrap" style={{ fontSize: getFontSize(fmt.baseSizes.infoValue, scales.infoTextSize) }}>{texts.time}</p></div>
                            </div>
                        </div>
                    </DraggableItem>
                    <div className="flex-grow"></div>
                    <div className="w-full flex flex-col items-center justify-center pointer-events-none" style={{ transform: `translate(${scales.footerX || 0}px, ${scales.footerY || 0}px)` }}>
                         <div className="pointer-events-auto mb-1">
                             <DraggableItem id="footerTitle" x={scales.footerTitleX} y={scales.footerTitleY} scaleVal={scales.footerTitle} fontSizeVal={scales.footerTitleSize} widthVal={scales.footerTitleWidth} scaleFactor={previewScale} onMove={(x, y) => onElementMove('footerTitle', x, y)} onScale={(s) => onElementResize('footerTitle', s)} onFontSize={(s) => onElementFontSize('footerTitle', s)} onWidth={(w) => onElementWidth('footerTitle', w)} onDragStatus={onDragStatus} onEdit={onEditElement} disabled={isExporting} isSelected={selectedElementId === 'footerTitle'} onSelect={onSelectElement}>
                                <div style={{ width: `${scales.footerTitleWidth}%`, transform: `scale(${scales.footerTitle/100})`, transformOrigin: 'center' }} className="mx-auto"><p className="uppercase font-bold tracking-[0.2em] text-center" style={{ color: theme.accent, fontSize: getFontSize(fmt.baseSizes.footerTitle, scales.footerTitleSize || 100) }}>{texts.footerTitle}</p></div>
                             </DraggableItem>
                         </div>
                        <div className="flex flex-col items-center justify-center text-gray-300 pointer-events-auto">
                            <div className="mb-0.5" style={{ width: '100%' }}>
                                <DraggableItem id="footerAddr" x={scales.footerAddrX} y={scales.footerAddrY} scaleVal={scales.footerAddr} fontSizeVal={scales.footerAddrSize} widthVal={scales.footerAddrWidth} scaleFactor={previewScale} onMove={(x, y) => onElementMove('footerAddr', x, y)} onScale={(s) => onElementResize('footerAddr', s)} onFontSize={(s) => onElementFontSize('footerAddr', s)} onWidth={(w) => onElementWidth('footerAddr', w)} onDragStatus={onDragStatus} onEdit={onEditElement} disabled={isExporting} isSelected={selectedElementId === 'footerAddr'} onSelect={onSelectElement} className="w-full flex justify-center">
                                    <div style={{ width: `${scales.footerAddrWidth}%`, transform: `scale(${scales.footerAddr/100})`, transformOrigin: 'center' }} className="mx-auto"><p className="font-medium opacity-80 text-center w-full whitespace-pre-wrap" style={{ fontSize: getFontSize(fmt.baseSizes.footerAddr, scales.footerAddrSize || 100) }}>{texts.address}</p></div>
                                </DraggableItem>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
});

function SidebarBtn({ icon, onClick, title }) { return <button onClick={onClick} title={title} className="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors">{icon}</button>; }
function FormatBtn({ active, onClick, icon, label, color }) { return <button onClick={onClick} className={`flex items-center justify-center gap-2 py-2 rounded text-[10px] font-bold uppercase transition-all border ${active ? 'bg-gray-800 border-transparent shadow-md' : 'border-gray-800 text-gray-500 hover:border-gray-700'}`} style={active ? { color: color } : {}}>{icon} {label}</button>; }
function TabBtn({ id, active, onClick, icon, label, color }) { const isActive = id === active; return <button onClick={() => onClick(id)} className={`flex-1 py-3 flex flex-col items-center gap-1 text-[9px] font-medium uppercase tracking-wide transition-colors relative`} style={{ color: isActive ? color : '#6b7280' }}>{icon}{label}{isActive && <div className="absolute bottom-0 left-0 w-full h-[2px]" style={{ backgroundColor: color }}></div>}</button>; }
function SectionTitle({ icon, title }) { return <div className="flex items-center gap-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">{icon} {title}</div>; }
function InputGroup({ label, value, onChange, isArea, rows, placeholder }) { 
    // FORÇAR TEXT-LEFT
    const className = `w-full bg-[#1f2937] border border-gray-700 rounded-lg px-3 py-2 text-xs font-medium text-white focus:border-gray-500 focus:ring-1 focus:ring-gray-500 focus:outline-none transition resize-none placeholder-gray-600 text-left`; 
    return <div><label className={`text-[9px] font-bold text-gray-500 uppercase ml-1 mb-1 block text-left`}>{label}</label>{isArea ? <textarea rows={rows} value={value} onChange={e => onChange(e.target.value)} className={className} placeholder={placeholder} /> : <input type="text" value={value} onChange={e => onChange(e.target.value)} className={className} placeholder={placeholder} />}</div>; 
}
function RangeControl({ label, value, onChange, min = 50, max = 200, unit = '%', displayValue = true, color }) { return <div className="space-y-1"><div className="flex justify-between text-[9px] font-bold text-gray-500 uppercase"><span>{label}</span> {displayValue && <span style={{ color: color }}>{value}{unit}</span>}</div><input type="range" min={min} max={max} value={value} onChange={e => onChange(e.target.value)} className="w-full" /></div>; }
